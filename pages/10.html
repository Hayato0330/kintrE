<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>é€é‡‘å±¥æ­´</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .page-title { margin: 0; }
    .hint { color: #666; margin: 8px 16px 12px; font-size: 13px; }
    .list-item { background: #fff; border-bottom: 1px solid #e7e7e7; padding: 12px 16px; }
    .line1 { display: flex; justify-content: space-between; gap: 12px; }
    .line2 { margin-top: 6px; color: #666; font-size: 13px; }
    .status { font-weight: 700; }
    .status.incomplete { color: #b06b00; }
    .status.complete { color: #0a7a2f; }
    .status.failed { color: #b00020; }
    .message { margin: 16px; color: #b00020; white-space: pre-wrap; }
    .topbar { display:flex; align-items:center; gap:10px; padding: 12px 16px; border-bottom: 1px solid #e7e7e7; background:#fff; }
    .back-btn { display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius: 10px; text-decoration:none; color:#111; }
    .back-btn:active { transform: scale(0.98); }
    .back-icon { width: 20px; height: 20px; }
    .page-title { margin: 0; font-size: 18px; line-height: 1.2; }
  </style>
</head>
<body>
  <div class="phone">
    <div class="screen" style="padding:0;">
      <div class="topbar">
        <a class="back-btn" href="./1.html" onclick="sessionStorage.setItem('access_granted', 'true');" aria-label="æˆ»ã‚‹" title="æˆ»ã‚‹">
          <!-- æ£’ãªã—ã®å·¦å‘ãçŸ¢å°ï¼ˆã‚·ã‚§ãƒ–ãƒ­ãƒ³ï¼‰ -->
          <svg class="back-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
        <h1 class="page-title">é€é‡‘å±¥æ­´</h1>
      </div>
      <p class="hint" id="hint"></p>
      <div id="message" class="message" hidden></div>
      <div id="list"></div>
    </div>
  </div>

  <script>
  // 1. é€šè¡Œæ‰‹å½¢ï¼ˆaccess_grantedï¼‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (!sessionStorage.getItem('access_granted')) {
    
    // â–¼ æ‰‹å½¢ãŒãªã„å ´åˆï¼ˆç›´æ‰“ã¡ï¼‰
    alert("ä¸æ­£ãªã‚¢ã‚¯ã‚»ã‚¹ã§ã™ã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
    // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚„å‰ã®ç”»é¢ã«å¼·åˆ¶çš„ã«æˆ»ã™
    location.href = "/";

  } else {

    // â–¼ æ‰‹å½¢ãŒã‚ã‚‹å ´åˆï¼ˆæ­£è¦ãƒ«ãƒ¼ãƒˆï¼‰
    
    // 2. äºŒåº¦ã¨ã“ã®ç”»é¢ã‚’è¡¨ç¤ºã•ã›ãªã„ãŸã‚ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼‰ã€æ‰‹å½¢ã‚’ã™ãã«ç ´ã‚Šæ¨ã¦ã‚‹
    sessionStorage.removeItem('access_granted');

    // ãã®ã¾ã¾ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹å‡¦ç†ã¸...
    console.log("æ­£è¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã™");
  }
</script>
  <script>
  const listEl = document.getElementById("list");
  const messageEl = document.getElementById("message");
  const hintEl = document.getElementById("hint");

  function escapeHtml(value) {
    return String(value).replace(/[&<>"']/g, (char) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[char]));
  }

  function showError(title, detail) {
    messageEl.hidden = false;
    messageEl.innerHTML = "<b>" + escapeHtml(title) + "</b>\n\n" + escapeHtml(detail || "");
    listEl.innerHTML = "";
  }

  function formatAmount(amount) {
    const num = Number(amount);
    if (!Number.isFinite(num)) return "-";
    return num.toLocaleString("ja-JP") + " å††";
  }

  // é€ä¿¡å…ˆæƒ…å ±ã‚’ accounts API ã‹ã‚‰å–å¾—ã™ã‚‹ï¼
  // æ³¨æ„ï¼šã“ã®URLã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã¯ï¼Œã‚ãªãŸã® /api/accounts å®Ÿè£…ã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼
    async function fetchAccountInfo(accountNumber) {
  try {
    const res = await fetch("/api/accounts?number=" + encodeURIComponent(accountNumber), {
      cache: "no-store"
    });
    const data = await res.json();
     
    console.log("accounts response:", data);

    if (!res.ok) return null;

    // accounts.js ã®è¿”å´ä»•æ§˜ã«å®Œå…¨ä¸€è‡´ã•ã›ã‚‹
    let icon = data.icon_url ?? null;

    // ç›¸å¯¾ãƒ‘ã‚¹å¯¾ç­–ï¼ˆ/ å§‹ã¾ã‚Šã‚‚ human/ å§‹ã¾ã‚Šã‚‚å…¨éƒ¨è£œæ­£ã™ã‚‹ï¼‰
    if (icon && typeof icon === "string") {
    icon = icon.trim();

    // ã™ã§ã« http(s) ãªã‚‰ãã®ã¾ã¾
    if (!/^https?:\/\//i.test(icon)) {
        // human/... ã¿ãŸã„ãªç›¸å¯¾ãƒ‘ã‚¹ã¯å…ˆé ­ã« / ã‚’ä»˜ã‘ã¦ãƒ«ãƒ¼ãƒˆåŸºæº–ã«ã™ã‚‹
        if (!icon.startsWith("/")) icon = "/" + icon;

        // ãƒ«ãƒ¼ãƒˆåŸºæº–ã®çµ¶å¯¾URLã¸
        icon = new URL(icon, location.origin).toString();
    }
    }


    return {
      name: data.name ?? null,
      icon: icon
    };
  } catch (e) {
    console.error(e);
    return null;
  }
  }


  function render(rows) {
    listEl.innerHTML = "";

    rows.forEach((row) => {
      const item = document.createElement("div");
      item.className = "list-item";

      const iconHtml = row.to_icon
        ? "<img src=\"" + escapeHtml(row.to_icon) + "\" alt=\"icon\" style=\"width:36px;height:36px;border-radius:12px;object-fit:cover;\">"
        : "<div style=\"width:36px;height:36px;border-radius:12px;background:#f2f2f2;display:flex;align-items:center;justify-content:center;\">ğŸ‘¤</div>";

      const nameText = row.to_name ? row.to_name : "-";

      item.innerHTML =
        "<div class=\"line1\" style=\"align-items:center;\">" +
          "<div style=\"display:flex;align-items:center;gap:10px;\">" +
            iconHtml +
            "<div>" +
              "<div><b>é€ä¿¡å…ˆ:</b> " + escapeHtml(String(row.to_id ?? "-")) + "</div>" +
              "<div style=\"font-size:13px;color:#666;\">" + escapeHtml(nameText) + "</div>" +
            "</div>" +
          "</div>" +
          "<div><b>" + escapeHtml(formatAmount(row.amount)) + "</b></div>" +
        "</div>" +
        (row.message ? "<div class=\"line2\">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: " + escapeHtml(row.message) + "</div>" : "");

      listEl.appendChild(item);
    });
  }

  async function main() {
    // ã“ã“ã¯ 10.html æ—¢å­˜ã¨åŒã˜ã‚­ãƒ¼ã‚’ä½¿ã†ï¼:contentReference[oaicite:4]{index=4}
    const fromIdRaw = sessionStorage.getItem("target_account_number");

    if (!fromIdRaw) {
      showError("ã‚¨ãƒ©ãƒ¼", "é€é‡‘å…ƒIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    // getMySending.js ã¯ from_id ã‚’æ•´æ•°ã¨ã—ã¦è¦æ±‚ã™ã‚‹ï¼:contentReference[oaicite:5]{index=5}
    const fromId = parseInt(fromIdRaw, 10);
    if (!Number.isInteger(fromId)) {
      showError("ã‚¨ãƒ©ãƒ¼", "é€é‡‘å…ƒIDãŒæ•´æ•°ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    hintEl.textContent = "é€é‡‘å±¥æ­´: " + fromId;

    try {
      // getMySending.js ã«åˆã‚ã›ã‚‹ï¼ˆã‚¯ã‚¨ãƒªåã¯ from_idï¼‰:contentReference[oaicite:6]{index=6}
      const res = await fetch("/api/getMySending?from_id=" + encodeURIComponent(fromId), {
        cache: "no-store"
      });

      const data = await res.json();

      if (!res.ok) {
        showError("å–å¾—ã‚¨ãƒ©ãƒ¼", (data && data.error) ? data.error : ("HTTP " + res.status));
        return;
      }

      // è¿”ã‚Šå€¤ã¯ { success, from_id, history: [...] } :contentReference[oaicite:7]{index=7}
      const history = data && Array.isArray(data.history) ? data.history : [];

      if (history.length === 0) {
        showError("é€é‡‘å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“", "é€é‡‘å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        return;
      }

      // to_id ã‹ã‚‰é€ä¿¡å…ˆã®åå‰ï¼Œã‚¢ã‚¤ã‚³ãƒ³ã‚’å¼•ã„ã¦åˆä½“
      const enriched = await Promise.all(history.map(async (row) => {
        const info = await fetchAccountInfo(row.to_id);
        return {
          ...row,
          to_name: info?.name ?? null,
          to_icon: info?.icon ?? null
        };
      }));

      messageEl.hidden = true;
      render(enriched);

    } catch (error) {
      showError("é€šä¿¡ã‚¨ãƒ©ãƒ¼", error && error.message ? error.message : String(error));
    }
  }

  main();
</script>

</body>
</html>
