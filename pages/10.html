<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ÈÄÅÈáëÂ±•Ê≠¥</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .page-title { margin: 0; }
    .hint { color: #666; margin: 8px 16px 12px; font-size: 13px; }
    .list-item { background: #fff; border-bottom: 1px solid #e7e7e7; padding: 12px 16px; }
    .line1 { display: flex; justify-content: space-between; gap: 12px; }
    .line2 { margin-top: 6px; color: #666; font-size: 13px; }
    .status { font-weight: 700; }
    .status.incomplete { color: #b06b00; }
    .status.complete { color: #0a7a2f; }
    .status.failed { color: #b00020; }
    .message { margin: 16px; color: #b00020; white-space: pre-wrap; }
    .topbar { display:flex; align-items:center; gap:10px; padding: 12px 16px; border-bottom: 1px solid #e7e7e7; background:#fff; }
    .back-btn { display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius: 10px; text-decoration:none; color:#111; }
    .back-btn:active { transform: scale(0.98); }
    .back-icon { width: 20px; height: 20px; }
    .page-title { margin: 0; font-size: 18px; line-height: 1.2; }
  </style>
</head>
<body>
  <div class="phone">
    <div class="screen" style="padding:0;">
      <div class="topbar">
        <a class="back-btn" href="./1.html" aria-label="ÔøΩﬂÇÔøΩ" title="ÔøΩﬂÇÔøΩ">
      

          <svg class="back-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
        <h1 class="page-title">ÈÄÅÈáëÂ±•Ê≠¥</h1>
      </div>
      <p class="hint" id="hint"></p>
      <div id="message" class="message" hidden></div>
      <div id="list"></div>
    </div>
  </div>

  <script>
  const listEl = document.getElementById("list");
  const messageEl = document.getElementById("message");
  const hintEl = document.getElementById("hint");

  function escapeHtml(value) {
    return String(value).replace(/[&<>"']/g, (char) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[char]));
  }

  function showError(title, detail) {
    messageEl.hidden = false;
    messageEl.innerHTML = "<b>" + escapeHtml(title) + "</b>\n\n" + escapeHtml(detail || "");
    listEl.innerHTML = "";
  }

  function formatAmount(amount) {
    const num = Number(amount);
    if (!Number.isFinite(num)) return "-";
    return num.toLocaleString("ja-JP") + " ÂÜÜ";
  }

  // ÈÄÅ‰ø°ÂÖàÊÉÖÂ†±„Çí accounts API „Åã„ÇâÂèñÂæó„Åô„ÇãÔºé
  // Ê≥®ÊÑèÔºö„Åì„ÅÆURL„Å®„É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè„ÅØÔºå„ÅÇ„Å™„Åü„ÅÆ /api/accounts ÂÆüË£Ö„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„ÇãÔºé
    async function fetchAccountInfo(accountNumber) {
  try {
    const res = await fetch("/api/accounts?number=" + encodeURIComponent(accountNumber), {
      cache: "no-store"
    });
    const data = await res.json();
    if (!res.ok) return null;

    // accounts.js „ÅÆËøîÂç¥‰ªïÊßò„Å´ÂÆåÂÖ®‰∏ÄËá¥„Åï„Åõ„Çã
    let icon = data.icon_url ?? null;

    // Áõ∏ÂØæ„Éë„ÇπÂØæÁ≠ñ
    if (icon && icon.startsWith("/")) {
      icon = new URL(icon, location.origin).toString();
    }

    return {
      name: data.name ?? null,
      icon: icon
    };
  } catch (e) {
    console.error(e);
    return null;
  }
  }


  function render(rows) {
    listEl.innerHTML = "";

    rows.forEach((row) => {
      const item = document.createElement("div");
      item.className = "list-item";

      const iconHtml = row.to_icon
        ? "<img src=\"" + escapeHtml(row.to_icon) + "\" alt=\"icon\" style=\"width:36px;height:36px;border-radius:12px;object-fit:cover;\">"
        : "<div style=\"width:36px;height:36px;border-radius:12px;background:#f2f2f2;display:flex;align-items:center;justify-content:center;\">üë§</div>";

      const nameText = row.to_name ? row.to_name : "-";

      item.innerHTML =
        "<div class=\"line1\" style=\"align-items:center;\">" +
          "<div style=\"display:flex;align-items:center;gap:10px;\">" +
            iconHtml +
            "<div>" +
              "<div><b>ÈÄÅ‰ø°ÂÖà:</b> " + escapeHtml(String(row.to_id ?? "-")) + "</div>" +
              "<div style=\"font-size:13px;color:#666;\">" + escapeHtml(nameText) + "</div>" +
            "</div>" +
          "</div>" +
          "<div><b>" + escapeHtml(formatAmount(row.amount)) + "</b></div>" +
        "</div>" +
        (row.message ? "<div class=\"line2\">„É°„ÉÉ„Çª„Éº„Ç∏: " + escapeHtml(row.message) + "</div>" : "");

      listEl.appendChild(item);
    });
  }

  async function main() {
    // „Åì„Åì„ÅØ 10.html Êó¢Â≠ò„Å®Âêå„Åò„Ç≠„Éº„Çí‰Ωø„ÅÜÔºé:contentReference[oaicite:4]{index=4}
    const fromIdRaw = sessionStorage.getItem("target_account_number");

    if (!fromIdRaw) {
      showError("„Ç®„É©„Éº", "ÈÄÅÈáëÂÖÉID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Åã„ÇâÊìç‰Ωú„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      return;
    }

    // getMySending.js „ÅØ from_id „ÇíÊï¥Êï∞„Å®„Åó„Å¶Ë¶ÅÊ±Ç„Åô„ÇãÔºé:contentReference[oaicite:5]{index=5}
    const fromId = parseInt(fromIdRaw, 10);
    if (!Number.isInteger(fromId)) {
      showError("„Ç®„É©„Éº", "ÈÄÅÈáëÂÖÉID„ÅåÊï¥Êï∞„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
      return;
    }

    hintEl.textContent = "ÈÄÅÈáëÂ±•Ê≠¥: " + fromId;

    try {
      // getMySending.js „Å´Âêà„Çè„Åõ„ÇãÔºà„ÇØ„Ç®„É™Âêç„ÅØ from_idÔºâ:contentReference[oaicite:6]{index=6}
      const res = await fetch("/api/getMySending?from_id=" + encodeURIComponent(fromId), {
        cache: "no-store"
      });

      const data = await res.json();

      if (!res.ok) {
        showError("ÂèñÂæó„Ç®„É©„Éº", (data && data.error) ? data.error : ("HTTP " + res.status));
        return;
      }

      // Ëøî„ÇäÂÄ§„ÅØ { success, from_id, history: [...] } :contentReference[oaicite:7]{index=7}
      const history = data && Array.isArray(data.history) ? data.history : [];

      if (history.length === 0) {
        showError("ÈÄÅÈáëÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì", "ÈÄÅÈáëÂ±•Ê≠¥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ");
        return;
      }

      // to_id „Åã„ÇâÈÄÅ‰ø°ÂÖà„ÅÆÂêçÂâçÔºå„Ç¢„Ç§„Ç≥„É≥„ÇíÂºï„ÅÑ„Å¶Âêà‰Ωì
      const enriched = await Promise.all(history.map(async (row) => {
        const info = await fetchAccountInfo(row.to_id);
        return {
          ...row,
          to_name: info?.name ?? null,
          to_icon: info?.icon ?? null
        };
      }));

      messageEl.hidden = true;
      render(enriched);

    } catch (error) {
      showError("ÈÄö‰ø°„Ç®„É©„Éº", error && error.message ? error.message : String(error));
    }
  }

  main();

  console.log(data.icon_url)
</script>

</body>
</html>
