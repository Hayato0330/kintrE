<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>送金相手を選択</title>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background:#f5f5f7}
    header{padding:16px 18px;font-weight:700;font-size:22px;background:#fff;border-bottom:1px solid #ddd}
    .wrap{max-width:520px;margin:0 auto}
    .list{background:#fff}
    .row{display:flex;align-items:center;gap:14px;padding:14px 18px;border-bottom:1px solid #eee;cursor:pointer}
    .row:hover{background:#fafafa}
    .avatar{width:54px;height:54px;border-radius:50%;border:1px solid #ddd;object-fit:cover;background:#fff}
    .name{font-size:20px;font-weight:600;flex:1}
    .chev{color:#bbb;font-size:26px;line-height:1}
    .err{padding:14px 18px;color:#b00020;background:#fff;white-space:pre-wrap}
    .small{color:#777;font-size:12px;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>送金相手を選択</header>
    <div id="list" class="list"></div>
  </div>

<script>
/* =========================================================
   共通関数
========================================================= */
const listEl = document.getElementById("list");

// XSS対策（文字のエスケープ）
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

// エラー表示
function showError(title, detail){
  listEl.innerHTML =
    `<div class="err"><b>${escapeHtml(title)}</b>\n\n${escapeHtml(detail)}</div>`;
}

// 画像パスの調整（httpで始まらない場合は ../ をつけるなど）
function normalizeIconPath(iconPath){
  if(!iconPath) return "../human/default.png"; // 画像がない場合のデフォルト
  if(/^https?:\/\//.test(iconPath)) return iconPath;
  return "../" + iconPath.replace(/^\.?\//, "");
}

/* =========================================================
   描画関数
   users: APIから取得した相手リスト
   myAcct: セッションから取得した自分の口座番号
========================================================= */
function render(users, myAcct){
  listEl.innerHTML = "";

  users.forEach(u => {
    // APIの返却値に合わせて変数名を調整 (account_number か number か)
    const targetNumber = u.account_number || u.number;
    const targetName = u.name || "名称未設定";
    const targetIcon = u.icon || u.aicon || "";

    const row = document.createElement("div");
    row.className = "row";

    // 1. アイコン
    const img = document.createElement("img");
    img.className = "avatar";
    img.alt = "avatar";
    img.src = normalizeIconPath(targetIcon);
    img.onerror = () => { img.src = "../human/default.png"; }; // エラー時の予備

    // 2. 名前と口座番号
    const nameDiv = document.createElement("div");
    nameDiv.className = "name";
    nameDiv.innerHTML = `${escapeHtml(targetName)}<div class="small">口座番号: ${escapeHtml(targetNumber)}</div>`;

    // 3. 送金ボタン
    const btn = document.createElement("button");
    btn.textContent = "送金";
    // スタイル設定（CSSクラスにしてもOK）
    Object.assign(btn.style, {
      padding: "8px 14px",
      fontSize: "14px",
      border: "none",
      borderRadius: "8px",
      background: "#007AFF",
      color: "#fff",
      cursor: "pointer"
    });

    // ★★★ ボタンクリック時の処理 ★★★
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); // 親要素のクリックイベントを止める

      // 自分の番号(myAcct) と 相手の番号(targetNumber) を持って次へ
      location.href = `sent tab.html?from=${encodeURIComponent(myAcct)}&to=${encodeURIComponent(targetNumber)}`;
    });

    // 4. 矢印（装飾）
    const chev = document.createElement("div");
    chev.className = "chev";
    chev.textContent = "›";

    // 要素を追加
    row.appendChild(img);
    row.appendChild(nameDiv);
    row.appendChild(btn);   
    row.appendChild(chev);

    listEl.appendChild(row);
  });
}

/* =========================================================
   メイン処理（ページ読み込み時に実行）
========================================================= */
async function init() {
  try {
    // 1. セッションから自分の番号を取り出す
    const myAcct = sessionStorage.getItem('target_account_number');

    // データがない場合の安全策
    if (!myAcct) {
      showError("エラー", "口座番号が見つかりません。もう一度トップページから操作してください。");
      // 数秒後にトップに戻すなどの処理を入れても良い
      return; 
    }

    console.log("自分の口座番号:", myAcct);

    // 2. APIから送金相手リストを取得（自分を除外）
    const res = await fetch(`/api/recipients?exclude_number=${encodeURIComponent(myAcct)}`, {
      cache: "no-store"
    });
    
    // エラーハンドリング
    if(!res.ok){
      const data = await res.json().catch(() => ({})); // JSONパース失敗対策
      showError("送金相手の取得に失敗", data.error || `ステータスコード: ${res.status}`);
      return;
    }

    const data = await res.json();

    // データが空の場合
    if(!Array.isArray(data) || data.length === 0){
      showError("送金相手がいません", "他に登録されているユーザーが見つかりませんでした。");
      return;
    }

    // 3. 画面に表示 (自分の番号も渡す)
    render(data, myAcct);

  } catch(e) {
    console.error(e);
    showError("通信エラー", e.message || "予期せぬエラーが発生しました");
  }
}

// 実行開始
init();

</script>
</body>
</html>