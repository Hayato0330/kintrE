<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>送金相手を選択</title>
<<<<<<< HEAD
  <link rel="stylesheet" href="../style.css">
=======
  <link rel="stylesheet" href="style.css">
>>>>>>> a22a48363d8ea4a144b15a1f321c77f5381063e2
</head>
<body>
  <div class="phone"> 
          <div class="screen"> 
  <div class="wrap">
    <header>送金相手を選択</header>

    <!-- 上部に「自分の口座番号」表示（任意） -->
    <div class="hint" id="meHint" style="display:none;"></div>

    <div id="list" class="list"></div>
  </div>
<<<<<<< HEAD

<script>
/* =========================================================
   共通
========================================================= */
const listEl = document.getElementById("list");
const meHint = document.getElementById("meHint");

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

function showError(title, detail){
  listEl.innerHTML =
    `<div class="err"><b>${escapeHtml(title)}</b><pre style="white-space:pre-wrap;margin:8px 0 0;">${escapeHtml(detail)}</pre></div>`;
}

function normalizeIconPath(iconUrl){
  // icon_url が絶対URLならそのまま
  if(!iconUrl) return "https://via.placeholder.com/54";
  if(/^https?:\/\//.test(iconUrl)) return iconUrl;

  // 例: "human/human1.png" を受け取ったら pages/ からは "../human/human1.png"
  return "../" + String(iconUrl).replace(/^\.?\//, "");
}

/* =========================================================
   描画（APIの返却: [{id, name, icon_url}, ...]）
========================================================= */
function render(users){
  listEl.innerHTML = "";

  users.forEach(u => {
    const row = document.createElement("div");
    row.className = "row";

    const img = document.createElement("img");
    img.className = "avatar";
    img.alt = "avatar";
    img.src = normalizeIconPath(u.icon_url);

    const name = document.createElement("div");
    name.className = "name";
    name.innerHTML = `${escapeHtml(u.name ?? "")}`;

    const chev = document.createElement("div");
    chev.className = "chev";
    chev.textContent = "›";

    row.appendChild(img);
    row.appendChild(name);
    row.appendChild(chev);

    // 行クリック：送金画面へ（相手idを渡す）
    row.addEventListener("click", () => {
      location.href = `sent tab.html?recipient_id=${encodeURIComponent(u.id)}`;
    });

    listEl.appendChild(row);
  });
}

/* =========================================================
   メイン
========================================================= */
(async () => {
  // ★あなたのコード：URLから自分の口座番号を取得
  const params = new URLSearchParams(location.search);
  const myAccountNumber = params.get("number");

  // デバッグ表示
  console.log("口座番号:", myAccountNumber);

  // URLに無ければ localStorage から補助的に拾う（任意）
  const fallback = localStorage.getItem("my_account_number");
  const my = myAccountNumber || fallback;

  if(!my){
    showError(
      "自分の口座番号が見つかりません",
      "例: human_select.html?number=100001 のようにURLに付けて開いてください"
    );
    return;
  }

  // 上部に自分の口座番号を出す（任意）
  meHint.style.display = "block";
  meHint.textContent = `あなたの口座番号：${my}`;

  try{
    const res = await fetch(`/api/recipients?exclude_number=${encodeURIComponent(my)}`, {
      cache: "no-store",
      headers: { "Accept": "application/json" }
    });

    const ct = res.headers.get("content-type") || "";
    const text = await res.text();

    if(!res.ok){
      showError("APIエラー", `HTTP ${res.status}\n${text}`);
      return;
    }

    if(!ct.includes("application/json")){
      showError("APIエラー", "JSON以外が返ってきました（APIが動いていない可能性）");
      return;
    }

    const users = JSON.parse(text);

    if(!Array.isArray(users)){
      showError("APIエラー", "返却が配列ではありません");
      return;
    }

    if(users.length === 0){
      showError("送金先がありません", "自分以外のユーザーが登録されていない可能性があります");
      return;
    }

    render(users);

  } catch(e){
    showError("通信エラー", "APIに接続できませんでした");
  }
})();
</script>
=======
  </div>
  </div>
>>>>>>> a22a48363d8ea4a144b15a1f321c77f5381063e2
</body>
</html>
