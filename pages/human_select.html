<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>送金相手を選択</title>

  <!-- ★口座画面と同じCSSを使う（パスはあなたの構成に合わせて調整） -->
  <link rel="stylesheet" href="style.css" />

  <!-- ※style.cssを使わない/読み込めない場合の最低限フォールバック（任意） -->
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background:#ffffff}
    header{padding:16px 18px;font-weight:700;font-size:22px;background:#fff;border-bottom:1px solid #ddd}
    .wrap{max-width:520px;margin:0 auto}
    .err{padding:14px 18px;color:#b00020;background:#fff;white-space:pre-wrap}
    .small{color:#777;font-size:12px;margin-top:4px}

    /* style.cssに無い場合だけ効く */
    .primary-compact{
      width:auto;
      min-height:40px;
      margin-top:0;
      padding:6px 12px;
      font-size:14px;
      border-radius:10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- style.cssの.page-titleを活用 -->
    <div class="page-title">送金相手を選択</div>
    <div id="list"></div>
  </div>
  <script>
  // 1. 通行手形（access_granted）があるかチェック
  if (!sessionStorage.getItem('access_granted')) {
    
    // ▼ 手形がない場合（直打ち）
    alert("不正なアクセスです。最初からやり直してください。");
    // トップページや前の画面に強制的に戻す
    location.href = "/";

  } else {

    // ▼ 手形がある場合（正規ルート）
    
    // 2. 二度とこの画面を表示させないため（リロード対策）、手形をすぐに破り捨てる
    sessionStorage.removeItem('access_granted');

    // そのまま画面を表示する処理へ...
    console.log("正規のアクセスです");
  }
</script>

<script>
/* =========================================================
  DB(API)のみ使用版
  - 自分の口座番号：sessionStorage['target_account_number']
  - 送金先一覧：GET /api/recipients?exclude_number=...
  - 行全体クリックでも遷移
  - 送金ボタンも遷移（stopPropagationで二重発火防止）
========================================================= */

const listEl = document.getElementById("list");

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

function showError(title, detail){
  listEl.innerHTML = `<div class="err"><b>${escapeHtml(title)}</b>\n\n${escapeHtml(detail)}</div>`;
}

function normalizeIconPath(p){
  if(!p) return "https://via.placeholder.com/60";
  const s = String(p).trim();
  if(/^https?:\/\//.test(s)) return s;
  // pages/human_select.html から human/xxx.png を指す想定（CSVではなくても相対パスが返る場合に対応）
  return "../" + s.replace(/^\.?\//, "");
}

function getAccountNumber(u){
  return (u.account_number ?? u.number ?? u.accountNumber ?? "").toString().trim();
}

function getIcon(u){
  return u.icon_url ?? u.aicon ?? u.icon ?? u.avatar ?? "";
}

function render(users){
  listEl.innerHTML = "";

  users.forEach(u => {
    const toAcct = getAccountNumber(u);
    const toName = (u.name ?? "---").toString();

    // 行（人1人分）
    const row = document.createElement("div");
    row.className = "list-row";

    // 行全体クリックでも遷移
    row.addEventListener("click", () => {
      if(!toAcct){
        showError("エラー", "送金先の口座番号が取得できません。APIの返却キー(account_number / number)を確認してください。");
        return;
      }
      sessionStorage.setItem("send_to_account", toAcct);
      location.href = "./sent tab.html";
    });

    // アイコン
    const img = document.createElement("img");
    img.className = "avatar";
    img.alt = "avatar";
    img.src = normalizeIconPath(getIcon(u));

    // 名前/口座番号
    const name = document.createElement("div");
    name.className = "name";
    name.innerHTML = `${escapeHtml(toName)}<div class="small">口座番号: ${escapeHtml(toAcct || "-")}</div>`;

    // 送金ボタン（口座画面と同じ.primaryで色変化）
    const btn = document.createElement("button");
    btn.className = "primary primary-compact";
    btn.type = "button";
    btn.textContent = "送金";

    // ボタンクリック時は行クリックを止める
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      if(!toAcct){
        showError("エラー", "送金先の口座番号が取得できません。APIの返却キー(account_number / number)を確認してください。");
        return;
      }
      sessionStorage.setItem("send_to_account", toAcct);
      location.href = "./sent tab.html";
    });

    // > 表示
    const chev = document.createElement("div");
    chev.className = "chev";
    chev.textContent = "›";

    row.appendChild(img);
    row.appendChild(name);
    row.appendChild(btn);
    row.appendChild(chev);

    listEl.appendChild(row);
  });
}

async function main(){
  const myAcct = sessionStorage.getItem("target_account_number");
  if(!myAcct){
    showError("エラー", "口座番号が見つかりません。もう一度トップページから操作してください。");
    return;
  }

  try{
    const res = await fetch(`/api/recipients?exclude_number=${encodeURIComponent(myAcct)}`, { cache: "no-store" });
    const data = await res.json();

    if(!res.ok){
      showError("送金相手の取得に失敗", data?.error ?? "不明なエラー");
      return;
    }

    if(!Array.isArray(data) || data.length === 0){
      showError("送金相手がいません", "DBに自分以外のユーザーが登録されているか確認してください。");
      return;
    }

    render(data);

  }catch(e){
    showError("通信エラー", e?.message ?? String(e));
  }
}

main();
</script>
</body>
</html>
