<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>送金相手を選択</title>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background:#f5f5f7}
    header{padding:16px 18px;font-weight:700;font-size:22px;background:#fff;border-bottom:1px solid #ddd}
    .wrap{max-width:520px;margin:0 auto}
    .list{background:#fff}
    .row{display:flex;align-items:center;gap:14px;padding:14px 18px;border-bottom:1px solid #eee;cursor:pointer}
    .row:hover{background:#fafafa}
    .avatar{width:54px;height:54px;border-radius:50%;border:1px solid #ddd;object-fit:cover;background:#fff}
    .name{font-size:20px;font-weight:600;flex:1}
    .chev{color:#bbb;font-size:26px;line-height:1}
    .err{padding:14px 18px;color:#b00020;background:#fff;white-space:pre-wrap}
    .small{color:#777;font-size:12px;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>送金相手を選択</header>
    <div id="list" class="list"></div>
  </div>

<script>
/* =========================================================
   共通設定・関数
========================================================= */
const listEl = document.getElementById("list");

// XSS対策
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

// エラー表示
function showError(title, detail){
  listEl.innerHTML =
    `<div class="err"><b>${escapeHtml(title)}</b>\n\n${escapeHtml(detail)}</div>`;
}

// 画像パス補正
function normalizeIconPath(iconPath){
  if(!iconPath) return "../human/default.png"; // 画像がない場合のデフォルト
  if(/^https?:\/\//.test(iconPath)) return iconPath;
  return "../" + iconPath.replace(/^\.?\//, "");
}

/* =========================================================
   描画関数
========================================================= */
function render(users){
  listEl.innerHTML = "";

  users.forEach(u => {
    // APIのレスポンスに合わせてキー名を調整
    // DBのカラム名が account_number なのか number なのか両対応
    const targetNumber = u.account_number || u.number; 
    const targetName = u.name || "名称未設定";
    const targetIcon = u.icon || u.aicon || ""; // CSV時代のaiconとAPIのicon両対応

    const row = document.createElement("div");
    row.className = "row";

    // 1. 画像
    const img = document.createElement("img");
    img.className = "avatar";
    img.alt = "avatar";
    img.src = normalizeIconPath(targetIcon);
    img.onerror = () => { img.src = "../human/default.png"; };

    // 2. 名前と番号
    const nameDiv = document.createElement("div");
    nameDiv.className = "name";
    nameDiv.innerHTML = `${escapeHtml(targetName)}<div class="small">口座番号: ${escapeHtml(targetNumber)}</div>`;

    // 3. 送金ボタン
    const btn = document.createElement("button");
    btn.textContent = "送金";
    // ボタンのスタイル設定
    Object.assign(btn.style, {
      padding: "8px 14px",
      fontSize: "14px",
      border: "none",
      borderRadius: "8px",
      background: "#007AFF",
      color: "#fff",
      cursor: "pointer"
    });

    // ★ボタンクリック時の処理
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); 

      // 相手の口座番号をセッションに保存
      sessionStorage.setItem('send_to_account', targetNumber);
      
      // 次の画面へ遷移 (ファイル名に合わせて調整してください)
      // ここでは同じフォルダにある 'sent tab.html' へ遷移すると仮定
      location.href = "sent tab.html"; 
    });

    const chev = document.createElement("div");
    chev.className = "chev";
    chev.textContent = "›";

    // 要素を追加
    row.appendChild(img);
    row.appendChild(nameDiv);
    row.appendChild(btn);   
    row.appendChild(chev);

    listEl.appendChild(row);
  });
}

/* =========================================================
   メイン処理
========================================================= */
async function main(){
  try {
    // 1. セッションから「自分の口座番号」を取り出す
    const myAcct = sessionStorage.getItem('target_account_number');

    // データがない場合のチェック
    if (!myAcct) {
      showError("エラー", "自分の口座番号が見つかりません。\nトップページからやり直してください。");
      return; 
    }

    console.log("自分の口座番号:", myAcct);

    // 2. APIからリスト取得 (自分を除外)
    const res = await fetch(`/api/recipients?exclude_number=${encodeURIComponent(myAcct)}`, {
      cache: "no-store"
    });
    
    // エラーハンドリング
    if(!res.ok){
      const errData = await res.json().catch(()=>({}));
      showError("送金相手の取得に失敗", errData.error || "サーバーエラー");
      return;
    }

    const data = await res.json();

    // 相手がいない場合
    if(!Array.isArray(data) || data.length === 0){
      showError("送金相手がいません", "他に登録されているユーザーが見つかりませんでした。");
      return;
    }

    // 3. 描画実行
    render(data);

  } catch(e) {
    console.error(e);
    showError("通信エラー", e.message || "予期せぬエラーが発生しました");
  }
}

// 実行
main();

</script>
</body>
</html>