<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>請求内容の確認</title>
  <link rel="stylesheet" href="style.css">
  <script src="main.js" defer></script>
</head>

<body>
<div class="phone"> 
<div class="screen"> 

  <header class="to-header">
    <div class="to-name">請求元</div>
    <div class="to-id" id="sender-name">読み込み中...</div>
  </header>

  <hr style="border:none;border-top:1px solid #eee;margin:12px 0;">

 
  <!-- 上限金額 -->
  <div class="row">
    <div class="label">上限金額</div>
    <div class="value">
      <span id="limit">---</span> 円
    </div>
  </div>
 
  <!-- 請求金額 -->
  <div class="row" style="align-items:flex-end;">
    <div>
      <div class="label">請求金額</div>
      <div class="muted">相手からの請求額</div>
    </div>
    <div class="value">
      <span id="requestAmount">0</span> 円
    </div>
  </div>

  <!-- メッセージ -->
  <div class="row" style="margin-top:12px;">
    <div>
      <div class="label">メッセージ</div>
      <div id="message" style="color:#666;font-size:14px;">---</div>
    </div>
  </div>

 <!-- 送金ボタン -->
<button class="primary" id="sendBtn">送金する</button>

<!-- エラーメッセージ -->
<div id="msg" style="color:red;margin-top:12px;"></div>
</div>
</div>

<script>
  let currentBillId = null;

  (async () => {
    // URLパラメータからbill_idを取得
    const params = new URLSearchParams(window.location.search);
    const billId = params.get("bill_id");
    currentBillId = billId;

    if (!billId) {
      document.getElementById("msg").textContent = "bill_idが指定されていません";
      return;
    }

    try {
      // APIを呼び出して請求情報を取得
      const res = await fetch(`/api/requestbills?bill_id=${encodeURIComponent(billId)}`);
      console.log(res);
      const data = await res.json();
      console.log(data);

      if (!res.ok) {
        document.getElementById("msg").textContent = data?.error ?? "読み込みに失敗しました";
        return;
      }

      // 表示を更新
      document.getElementById("sender-name").textContent = data.sender_name ?? "---";
      document.getElementById("requestAmount").textContent = Number(data.amount ?? 0).toLocaleString("ja-JP");
      document.getElementById("message").textContent = data.message ?? "メッセージなし";

    } catch (e) {
      document.getElementById("msg").textContent = "通信エラーです";
      console.error(e);
    }
  })();




  // 送金ボタンのクリックイベント
  document.getElementById("sendBtn").addEventListener("click", async () => {
    // sessionStorageからログインユーザーのIDを取得
    const userId = sessionStorage.getItem("user_id");

    if (!userId) {
      document.getElementById("msg").textContent = "ユーザーIDが取得できません。ログインしてください。";
      return;
    }

    if (!currentBillId) {
      document.getElementById("msg").textContent = "bill_idが取得できません";
      return;
    }

    try {
      // 送金中の表示
      document.getElementById("sendBtn").disabled = true;
      document.getElementById("sendBtn").textContent = "送金中...";

      // update_bill APIを呼び出し
      const res = await fetch("/api/updatebills", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          bill_id: currentBillId,
          user_id: userId
        })
      });

      const data = await res.json();

      if (!res.ok) {
        document.getElementById("msg").textContent = data?.error ?? "更新に失敗しました";
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("sendBtn").textContent = "送金する";
        return;
      }

      // 成功したら4.htmlに遷移
      location.href = "4.html";

    } catch (e) {
      document.getElementById("msg").textContent = "通信エラーです";
      document.getElementById("sendBtn").disabled = false;
      document.getElementById("sendBtn").textContent = "送金する";
      console.error(e);
    }
  });
</script>

 
<script>
  (async () => {
    // URLパラメータからnumberを取得
    const params = new URLSearchParams(window.location.search);
    const number = params.get("number");
  

    if (!number) {
      document.getElementById("msg").textContent = "nemberが指定されていません";
      return;
    }

    try {
      // APIを呼び出して請求情報を取得
      const res = await fetch(`/api/balance?number=${encodeURIComponent(number)}`);
      console.log(res);
      const data = await res.json();
      console.log(data);

      if (!res.ok) {
        document.getElementById("msg").textContent = data?.error ?? "読み込みに失敗しました";
        return;
      }

      // 表示を更新
      document.getElementById("limit").textContent = data.balance ?? "---";


    } catch (e) {
      document.getElementById("msg").textContent = "通信エラーです";
      console.error(e);
    }
  })();
  </script>


    <!-- 7 送金ボタンクリック時 -->
<script>
    btn.addEventListener("click", async () => {
      const amountInput = document.getElementById("amount");
      const amount = parseInt(amountInput.value);

      msgDiv.textContent = "";

      // バリデーション
      if (!amount || amount <= 0) {
        msgDiv.textContent = "正しい金額を入力してください。";
        return;
      }
      if (amount > senderData.balance) {
        msgDiv.textContent = "残高不足です。";
        return;
      }

      // 二重送信防止
      btn.disabled = true;
      btn.textContent = "送金処理中...";

      try {
        const response = await fetch(API_SEND_MONEY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sender_id: senderId,
            recipient_id: recipientId,
            amount: amount,
            message: "送金"
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // alert("送金が完了しました！");
          // 完了画面へ (ファイル名に合わせてください)
          location.href = "4.html"; 
        } else {
          throw new Error(result.message || result.error || "送金に失敗しました");
        }

      } catch (error) {
        msgDiv.textContent = error.message;
        btn.disabled = false;
        btn.textContent = "送金する";
      }
    });
  </script>















<script>
  const sendBtn = document.getElementById("sendBtn");
  const msg = document.getElementById("msg");

  // URLから bill_id を取得
  const params = new URLSearchParams(window.location.search);
  const billId = params.get("bill_id");

  sendBtn.addEventListener("click", async () => {
    if (!billId) {
      msg.textContent = "bill_idが取得できません";
      return;
    }

    sendBtn.disabled = true;
    msg.textContent = "送金処理中…";

    try {
      const res = await fetch("/api/pay", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          bill_id: billId
        })
      });

      const data = await res.json();

      if (!res.ok) {
        msg.textContent = data.error || "送金に失敗しました";
        sendBtn.disabled = false;
        return;
      }

      // 成功 → 完了画面へ
      window.location.href = "4.html";

    } catch (e) {
      console.error(e);
      msg.textContent = "通信エラーです";
      sendBtn.disabled = false;
    }
  });
</script>

</body>
</html>