<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>請求リンク作成</title>

  <link rel="stylesheet" href="style.css">
</head>

<body>

  <div class="phone">
    <div class="screen">

      <!-- ★ 画面中央寄せ（CSS不要） -->
      <div style="
        min-height:100vh;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        text-align:center;
        padding:20px;
        width:100%;
        box-sizing:border-box;
      ">

        <!-- タイトル -->
        <div class="to-name" style="font-size:22px;font-weight:800;margin-bottom:10px;">
          作成完了です
        </div>

        <!-- サブテキスト -->
        <div class="to-id" style="font-size:14px;color:#555;margin-bottom:30px;">
          請求リンクをコピーして相手に送ってください
        </div>

        <!-- ★ 通知メッセージ用スペース（高さ固定 → ズレない） -->
        <div id="msg" style="
          margin-bottom:20px;
          min-height:22px;
          line-height:22px;
          font-size:14px;
        "></div>

        <div id="qrWrap" style="margin-top:18px;">
          <div style="font-size:13px;color:#555;margin-bottom:10px;">QRコード</div>
          <canvas id="qrCanvas"></canvas>
          <div id="qrErr" style="margin-top:10px;font-size:13px;color:#c00;"></div>
        </div>

        <!-- リンクコピー -->
        <button class="primary" type="button" onclick="copyLink()"
          style="width:100%; box-sizing:border-box; margin-bottom:12px;">
          リンクをコピー
        </button>

        <!-- トップへ戻る -->
        <button class="primary" id="sendBtn"
          style="width:100%; box-sizing:border-box;">
          トップ画面に戻る
        </button>

      </div>

    </div>
  </div>
  <script>
  // 1. 通行手形（access_granted）があるかチェック
  if (!sessionStorage.getItem('access_granted')) {
    
    // ▼ 手形がない場合（直打ち）
    alert("不正なアクセスです。最初からやり直してください。");
    // トップページや前の画面に強制的に戻す
    sessionStorage.setItem('access_granted', 'true');
    location.href = "/";

  } else {

    // ▼ 手形がある場合（正規ルート）
    
    // 2. 二度とこの画面を表示させないため（リロード対策）、手形をすぐに破り捨てる
    sessionStorage.removeItem('access_granted');

    // そのまま画面を表示する処理へ...
    console.log("正規のアクセスです");
  }
  </script>

  <script>
    const requestLink = sessionStorage.getItem('created_payment_link') || "リンクが見つかりません";
    
    console.log("コピー対象:", requestLink);

    let msgTimer = null;

    function copyLink() {
      navigator.clipboard.writeText(requestLink)
        .then(() => showMsg("コピーしました！", "ok"))
        .catch(() => showMsg("コピーに失敗しました", "err"));
    }

    function showMsg(text, type) {
      const el = document.getElementById("msg");
      el.className = type;
      el.textContent = text;

      if (msgTimer) clearTimeout(msgTimer);

      msgTimer = setTimeout(() => {
        el.textContent = "";      // 消えるが高さは固定なのでズレない
        el.className = "";
      }, 2000); // 2秒で消える
    }

    /* トップに戻る */
    document.getElementById("sendBtn").addEventListener("click", () => {
      sessionStorage.setItem('access_granted', 'true');
      location.href = "./1.html";
    });

    
  </script>

  <!-- QR生成ライブラリ（軽くて手軽） -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <!-- 自分のQR表示処理 -->
  <script src="../public/createqr.js"></script>

</body>
</html>
