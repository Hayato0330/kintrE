<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>口座画面</title>
  <link rel="stylesheet" href="pages/style.css" />
</head>

<body>
  <div class="phone">
    <div class="screen">
      <div class="center-box">

        <div class="profile">
          <img id="user_icon" src="https://via.placeholder.com/60" alt="アイコン" />
          <p class="name" id="user-name">---</p>
        </div>

        <p class="account">
          口座番号：<span id="account-number">0000000</span>
        </p>

        <!-- 残高ラベル -->
        <div class="row">
          <div class="label">残高</div>
        </div>

        <div class="row balance-money-row">
          <div class="value money-box">
            <span id="limit">0</span> 円
          </div>
        
          <button id="toggle-visibility" class="hide-btn" type="button">
            非表示
          </button>
        </div>
        


        <hr style="border:none;border-top:1px solid #eee;margin:12px 0;" />

        <!-- 送金する -->
        <button class="primary" type="button" id="sendBtn">送金する</button>

        <!-- 請求する -->
        <button class="primary" type="button" id="requestBtn">請求する</button>

        <!-- 請求履歴 -->
        <button class="primary" type="button" id="historyBtn">請求履歴</button>

        <div id="msg"></div>
      </div>
    </div>
  </div>

  <script>
    /* ------------ 金額アニメーション ------------- */
    function animateCount(el, to, durationMs = 500) {
      const start = 0;
      const end = Math.max(0, Math.floor(Number(to) || 0));
      const startTime = performance.now();

      function tick(now) {
        const t = Math.min(1, (now - startTime) / durationMs);
        const eased = 1 - Math.pow(1 - t, 3);
        const current = Math.floor(start + (end - start) * eased);
        el.textContent = current.toLocaleString("ja-JP");

        if (t < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    /* ------------ 残高表示の ON / OFF 切替 ------------- */
    let isHidden = false;
    let realBalance = 0;

    document.getElementById("toggle-visibility").addEventListener("click", () => {
      const limitEl = document.getElementById("limit");
      const btn = document.getElementById("toggle-visibility");

      btn.blur(); // 押した後、薄い青に戻す（フォーカス解除）

      if (!isHidden) {
        // 非表示へ
        limitEl.textContent = "---,---";
        btn.textContent = "表示";
        isHidden = true;
      } else {
        // 表示へ復帰
        limitEl.textContent = realBalance.toLocaleString("ja-JP");
        btn.textContent = "非表示";
        isHidden = false;
      }
    });


    /* ------------ ボタン遷移 ------------- */
    document.getElementById("sendBtn").addEventListener("click", () => {
      const acct =
        window.currentAccountNumber ??
        document.getElementById("account-number")?.textContent?.trim();

      if (!acct) {
        document.getElementById("msg").textContent = "口座番号が取得できません";
        return;
      }
      sessionStorage.setItem("target_account_number", acct);
      location.href = "pages/human_select.html";
    });

    document.getElementById("requestBtn").addEventListener("click", () => {
      const acct =
        window.currentAccountNumber ??
        document.getElementById("account-number")?.textContent?.trim();
      if (!acct) return;

      sessionStorage.setItem("target_account_number", acct);
      location.href = "pages/7-1.html";
    });

    document.getElementById("historyBtn").addEventListener("click", () => {
      const acct =
        window.currentAccountNumber ??
        document.getElementById("account-number")?.textContent?.trim();
      if (!acct) return;

      sessionStorage.setItem("target_account_number", acct);
      location.href = "pages/9.html";
    });

    /* ------------ APIから口座情報取得 ------------- */
    (async () => {
      const accountNumber = "100001";

      try {
        const res = await fetch(
          `/api/accounts?number=${encodeURIComponent(accountNumber)}`
        );
        const data = await res.json();

        if (!res.ok) {
          document.getElementById("msg").textContent =
            data?.error ?? "読み込みに失敗しました";
          return;
        }

        document.getElementById("user-name").textContent = data.name ?? "---";
        document.getElementById("account-number").textContent =
          data.account_number ?? accountNumber;

        realBalance = Number(data.balance ?? 0);
        
        // 残高
        realBalance = Number(data.balance ?? 0);
        animateCount(document.getElementById("limit"), realBalance, 500);

        window.currentAccountNumber = data.account_number ?? accountNumber;

        // アイコン
        const icon = data.icon_url ?? "https://via.placeholder.com/60";
        document.getElementById("user_icon").src = icon;
      } catch (e) {
        document.getElementById("msg").textContent = "通信エラーです";
      }
    })();
  </script>
</body>
</html>
