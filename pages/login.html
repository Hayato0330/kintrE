<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ログイン</title>

  <!-- 作成完了ページと同じCSSを使う -->
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="phone">
    <div class="screen">

      <!-- ★ 中央寄せ（作成完了ページと同じ） -->
      <div style="
        min-height:80vh;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        text-align:left;
        padding:20px;
        width:100%;
        box-sizing:border-box;
      ">

        <!-- タイトル -->
        <div class="to-name" style="font-size:30px;font-weight:800;margin-bottom:10px; width:100%;">
          ログイン
        </div>

        <!-- サブテキスト -->
        <div class="to-id" style="font-size:20px;color:#555;margin-bottom:22px; width:100%;">
          口座番号を入力してください
        </div>

        <!-- 入力欄（横長100%） -->
        <div style="width:100%; margin-bottom:14px;">
          <!-- style.css が input[type="number"] を装飾しているので number に合わせる -->
          <input
            id="number"
            type="number"
            inputmode="numeric"
            placeholder="例: 000000"
            style="width:100%; box-sizing:border-box;"
          />
        </div>

        <!-- ★ 通知メッセージ用スペース（ズレ防止） -->
        <div id="msg" style="
          width:100%;
          margin-bottom:16px;
          min-height:22px;
          line-height:22px;
          font-size:14px;
          color:#c00;
        "></div>

        <!-- ログイン -->
        <button class="primary" id="loginBtn"
          style="width:100%; box-sizing:border-box; margin-bottom:12px;">
          ログイン
        </button>



      </div>

    </div>
  </div>

  <script>
    let msgTimer = null;

    function showMsg(text) {
      const el = document.getElementById("msg");
      el.textContent = text;

      if (msgTimer) clearTimeout(msgTimer);
      msgTimer = setTimeout(() => {
        el.textContent = "";
      }, 2500);
    }

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const number = document.getElementById("number").value.trim();
      const msgEl  = document.getElementById("msg");
      msgEl.textContent = "";

      if (!number) {
        showMsg("口座番号を入力してください");
        return;
      }

      try {
        const apiUrl = new URL("/api/login", window.location.origin);
        const id = location.search.substring(1);
        apiUrl.searchParams.set("number", number);
        
        apiUrl.searchParams.set("bill_id", id); // ★この行を追加（キー名はバックエンドに合わせる）
      

        // 3. 送信（自動的に ?number=...&bill_id=... となります）
        const res = await fetch(apiUrl.toString(), { method: "GET" });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          showMsg(data?.error ?? `ログイン失敗 (status ${res.status})`);
          return;
        }

        // 他ページが sessionStorage.user_id を使っている前提で保存
        sessionStorage.setItem("user_id", String(data.number ?? number));

        // ログイン後遷移
        //location.href = `8.html?number=${encodeURIComponent(data.number ?? number)}`;
    const params = new URLSearchParams(window.location.search);
    const billId = params.get("bill_id");
    currentBillId = billId;
    sessionStorage.setItem("account_number", number);
    sessionStorage.setItem('access_granted', 'true');

    location.href = `8.html?bill_id=${billId}`;

      } catch (e) {
        showMsg("通信エラーです");
        console.error(e);
      }
    });



    
  </script>
</body>
</html>
