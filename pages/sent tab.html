<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>送金画面</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* 読み込み中の薄くするスタイル */
    .loading { opacity: 0.5; pointer-events: none; }
    /* エラーメッセージ */
    .error-msg { color: #e74c3c; font-size: 0.9em; margin-top: 10px; font-weight: bold; text-align: center; }
    /* 数値入力のスタイル調整 */
    input[type="number"] { width: 100%; box-sizing: border-box; padding: 10px; font-size: 16px; }
  </style>
</head>

<body>
 
  <header class="to-header">
    <div class="to-name">送金先</div>
    <div class="to-id" id="recipient-name">読み込み中...</div>
    <div class="to-id"> 個人番号
      <span id="recipient-number">---</span>
    </div>
  </header>

  <div class="row">
    <div class="label">上限金額 (残高)</div>
    <div class="value"><span id="limit-balance">---</span> 円</div>
  </div>

  <hr style="border:none;border-top:1px solid #eee;margin:12px 0;">

  <div class="row" style="align-items:flex-end; flex-wrap: wrap;">
    <div style="width: 100%; margin-bottom: 5px;">
      <div class="label">送金金額</div>
      <div class="muted" style="font-size:0.8em; color:#666;">0〜上限の範囲で入力</div>
    </div>
    
    <input id="amount" type="number" inputmode="numeric" min="1" step="1" placeholder="例: 1000" />
  </div>

  <button type="button" class="primary" id="sendBtn" disabled>読み込み中...</button>
   
  <div id="msg" class="error-msg"></div>

  <script>
    // ▼ APIのパス（あなたの環境に合わせてください）
    // ユーザー情報を取るAPI (例: /api/users?account_number=123)
    const API_GET_USER = '/api/users'; 
    // 送金API
    const API_SEND_MONEY = '/api/transactions';


    // 前の画面で保存したキー名に合わせて取得
    // 自分の番号
    const senderId = sessionStorage.getItem('target_account_number') || sessionStorage.getItem('send_from_account');
    // 相手の番号
    const recipientId = sessionStorage.getItem('send_to_account');

    let senderData = null;
    let recipientData = null;

    const btn = document.getElementById("sendBtn");
    const msgDiv = document.getElementById("msg");

    // 画面読み込み時に実行
    window.onload = async () => {
      // IDがない場合はエラー
      if (!senderId || !recipientId) {
        msgDiv.textContent = "エラー: 送金元または送金先の情報が不足しています。トップからやり直してください。";
        return;
      }

      console.log(`自分: ${senderId}, 相手: ${recipientId}`);

      try {
        // 自分と相手の情報を同時に取得
        // ※注意: APIのURLパラメータ(?number=...)は、あなたのバックエンドの実装に合わせてください
        const [senderRes, recipientRes] = await Promise.all([
            fetch(`${API_GET_USER}?number=${encodeURIComponent(senderId)}`),
            fetch(`${API_GET_USER}?number=${encodeURIComponent(recipientId)}`)
        ]);

        if (!senderRes.ok || !recipientRes.ok) {
          throw new Error("ユーザー情報の取得に失敗しました");
        }

        // データを取り出す
        // もしAPIが配列 [ {user...} ] で返してくるなら data[0] にする処理が必要
        const sData = await senderRes.json();
        const rData = await recipientRes.json();

        // APIが配列で返すかオブジェクトで返すかで分岐（念のため）
        senderData = Array.isArray(sData) ? sData[0] : sData;
        recipientData = Array.isArray(rData) ? rData[0] : rData;

        if(!senderData || !recipientData) {
          throw new Error("ユーザーデータが見つかりませんでした");
        }

        updateUI();

      } catch (error) {
        console.error(error);
        msgDiv.textContent = "データの読み込みに失敗しました: " + error.message;
      }
    };

    function updateUI() {
      // 画面に表示
      document.getElementById("recipient-name").textContent = recipientData.name || "名称未設定";
      // 口座番号を表示 (APIのキー名が account_number か number かに合わせて調整)
      document.getElementById("recipient-number").textContent = recipientData.account_number || recipientData.number;
      
      // 残高を表示
      document.getElementById("limit-balance").textContent = (senderData.balance || 0).toLocaleString();

      // 入力欄の上限設定
      const amountInput = document.getElementById("amount");
      if (amountInput) {
        amountInput.max = senderData.balance;
      }

      // ボタンを有効化
      btn.disabled = false;
      btn.textContent = "送金する";
    }

    // 送金ボタンクリック時
    btn.addEventListener("click", async () => {
      const amountInput = document.getElementById("amount");
      const amount = parseInt(amountInput.value);

      msgDiv.textContent = "";

      // バリデーション
      if (!amount || amount <= 0) {
        msgDiv.textContent = "正しい金額を入力してください。";
        return;
      }
      if (amount > senderData.balance) {
        msgDiv.textContent = "残高不足です。";
        return;
      }

      // 二重送信防止
      btn.disabled = true;
      btn.textContent = "送金処理中...";

      try {
        const response = await fetch(API_SEND_MONEY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sender_id: senderId,
            recipient_id: recipientId,
            amount: amount,
            message: "送金"
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // alert("送金が完了しました！");
          // 完了画面へ (ファイル名に合わせてください)
          location.href = "4.html"; 
        } else {
          throw new Error(result.message || result.error || "送金に失敗しました");
        }

      } catch (error) {
        msgDiv.textContent = error.message;
        btn.disabled = false;
        btn.textContent = "送金する";
      }
    });
  </script>

</body>
</html>