<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>送った請求の確認</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f5f5f7;
    }
    header {
      padding: 16px 18px;
      font-weight: 700;
      font-size: 22px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }
    .wrap {
      max-width: 520px;
      margin: 0 auto;
    }
    .list {
      background: #fff;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 18px;
      border-bottom: 1px solid #eee;
    }
    .row:hover {
      background: #fafafa;
    }
    .main {
      flex: 1;
    }
    .name {
      font-size: 16px;
      font-weight: 600;
    }
    .content {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    .link {
      font-size: 12px;
      color: #007AFF;
      margin-top: 4px;
      word-break: break-all;
    }
    .status {
      font-size: 16px;
      font-weight: 700;
      min-width: 48px;
      text-align: center;
    }
    .paid {
      color: #2e7d32;
    }
    .unpaid {
      color: #999;
    }
    .err {
      padding: 14px 18px;
      color: #b00020;
      background: #fff;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>送った請求の確認</header>
    <div id="list" class="list"></div>
  </div>

<script>
/* =====================================================
   設定
   今はCSV / 将来はAPIに差し替え
===================================================== */
const CSV_PATH = "../user_db.csv";

/* =====================================================
   エラーハンドリング
===================================================== */
function showError(message) {
  document.getElementById("list").innerHTML =
    `<div class="err">${message}</div>`;
}

/* =====================================================
   CSV → JSON（※ 将来削除する想定）
===================================================== */
function csvToRequests(csvText) {
  const lines = csvText.replace(/\r/g, "").split("\n").filter(l => l.trim());
  const headers = lines[0].split(",").map(h => h.trim());

  return lines.slice(1).map(line => {
    const cols = line.split(",");
    const row = {};
    headers.forEach((h, i) => row[h] = cols[i] || "");

    // ★ DB想定のデータ構造に変換
    return {
      id: row.id,
      link: row.link,
      toUser: row.to_user || row.toUser,
      content: row.content,
      status: row.status
    };
  });
}

/* =====================================================
   データ取得（ここだけ将来差し替える）
===================================================== */
async function fetchRequests() {
  // ▼ 今はCSV
  const res = await fetch(CSV_PATH, { cache: "no-store" });
  if (!res.ok) throw new Error("CSVを読み込めません");

  const text = await res.text();
  return csvToRequests(text);

}

/* =====================================================
   描画（データ取得元を一切気にしない）
===================================================== */
function renderRequests(requests) {
  const listEl = document.getElementById("list");
  listEl.innerHTML = "";

  if (requests.length === 0) {
    showError("請求データがありません");
    return;
  }

  requests.forEach(req => {
    const row = document.createElement("div");
    row.className = "row";

    const main = document.createElement("div");
    main.className = "main";
    main.innerHTML = `
      <div class="name">${req.toUser}</div>
      <div class="content">${req.content}</div>
      <div class="link">${req.link}</div>
    `;

    const status = document.createElement("div");
    status.className = "status";

    if (req.status === "paid") {
      status.textContent = "✓";
      status.classList.add("paid");
    } else {
      status.textContent = "未";
      status.classList.add("unpaid");
    }

    row.appendChild(main);
    row.appendChild(status);
    listEl.appendChild(row);
  });
}

/* =====================================================
   メイン処理
===================================================== */
async function main() {
  try {
    const requests = await fetchRequests();
    renderRequests(requests);
  } catch (e) {
    console.error(e);
    showError(e.message);
  }
}

main();
</script>
</body>
</html>
